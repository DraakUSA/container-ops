#!/bin/bash

source "$(dirname "$0")/../env.sh"

echo "Scanning $CONTAINERS_DIR for stacks..."

cat << EOF > "$STACKS_FILE"
########################################################################
# AUTO-GENERATED BY 'd discover'
# Generated on: $(date)
#
# Manual changes may be overwritten. To group stacks, edit this file
# and add custom headers, but be aware that running 'discover' again
# will reset the file layout.
########################################################################

EOF

# Finds folders containing docker-compose files and strips the 'containers/' prefix
find containers/ -maxdepth 3 -not -path '*/.*' -name "docker-compose.y*ml" -exec dirname {} \; | \
sed "s|^containers/||" | sort -u >> "$STACKS_FILE"

echo "Updated $STACKS_FILE with $(grep -v '^#' "$STACKS_FILE" | grep -c .) stacks."
